sap.ui.define([                                                                                                                                                                                                                                                
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
    "sap/ui/core/library",                                                                                                                                                                                                                                     
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/m/PDFViewer",                                                                                                                                                                                                                                         
    "sap/ui/model/Filter",                                                                                                                                                                                                                                     
    "sap/m/MessageBox",                                                                                                                                                                                                                                        
], function (MessageToast, CoreLibrary, JSONModel, PDFViewer, Filter, MessageBox) {                                                                                                                                                                            
    'use strict';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    var ValueState = CoreLibrary.ValueState;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    return {                                                                                                                                                                                                                                                   
        onInit: function () {                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onBeforeRendering: function () {                                                                                                                                                                                                                       
            this.getView().byId(this.byId("printPDF").getId()).setIcon("sap-icon://print");                                                                                                                                                                    
            this.getView().byId(this.byId("printAMST").getId()).setIcon("sap-icon://print");                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        getPDFData: function () {                                                                                                                                                                                                                              
            let oFilter = this.getView().byId("listReportFilter").getFilters();                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                        
            for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                                  
                var v_ordemFrete = oCtx.getObject().OrdemFrete                                                                                                                                                                                                 
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            // get the Model reference                                                                                                                                                                                                                         
            var oModel = this.getView().getModel();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                     
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                // Perform Read operation and pass billingdoc as parameter to URL                                                                                                                                                                              
                oModel.read("/PDF(p_ordemFrete='" + v_ordemFrete + "')/Set", {                                                                                                                                                                                 
                    //filters: oFilter,                                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    success: function (oData, oResponse) {                                                                                                                                                                                                     
                        resolve(oData);                                                                                                                                                                                                                        
                    },                                                                                                                                                                                                                                         
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject(oError);                                                                                                                                                                                                                        
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onPrintPDF: async function (oEvent) {                                                                                                                                                                                                                  
            let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                        
            for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                                  
                var v_ordemFrete = oCtx.getObject().OrdemFrete                                                                                                                                                                                                 
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            //var filterOrdemFrete = sap.ui.getCore().byId("br.com.simrede.tmsispetro::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_TM_SISPETRO--listReportFilter-filterItemControl_BASIC-OrdemFrete").mProperties._semanticFormValue;         
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            //if (filterOrdemFrete == '' || filterOrdemFrete == null){                                                                                                                                                                                         
            if (v_ordemFrete == '' || v_ordemFrete == null){&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                           
                MessageBox.error("Para extrair o relatório de Ordem de Carregamento é obrigatório informar uma Ordem de Frete.\nInforme a Ordem de Frete e tente novamente.");                                                                                 
            }else{                                                                                                                                                                                                                                             
                var opdfViewer = new PDFViewer();                                                                                                                                                                                                              
                this.getView().addDependent(opdfViewer);                                                                                                                                                                                                       
                // var oBusyDialog = new sap.m.BusyDialog({                                                                                                                                                                                                    
                //     title: 'Gerando PDF...'                                                                                                                                                                                                                 
                // });                                                                                                                                                                                                                                         
                // oBusyDialog.open();                                                                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                // Get the PDF data&nbsp;                                                                                                                                                                                                                      
                var vPDF = await this.getPDFData();                                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                if (vPDF === '') {                                                                                                                                                                                                                             
                    MessageBox.error("Erro ao gerar PDF")                                                                                                                                                                                                      
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                let base64EncodedPDF = vPDF.results[0].stream_data;                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                let decodedPdfContent = atob(base64EncodedPDF);                                                                                                                                                                                                
                let byteArray = new Uint8Array(decodedPdfContent.length);                                                                                                                                                                                      
                for (var i = 0; i < decodedPdfContent.length; i++) {                                                                                                                                                                                           
                    byteArray[i] = decodedPdfContent.charCodeAt(i);                                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
                var blob = new Blob([byteArray.buffer], {                                                                                                                                                                                                      
                    type: 'application/pdf'                                                                                                                                                                                                                    
                });                                                                                                                                                                                                                                            
                var pdfurl = URL.createObjectURL(blob);                                                                                                                                                                                                        
                jQuery.sap.addUrlWhitelist("blob"); // register blob url as whitelist                                                                                                                                                                          
                opdfViewer.setSource(pdfurl);                                                                                                                                                                                                                  
                opdfViewer.setVisible(true);                                                                                                                                                                                                                   
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                opdfViewer.setTitle("Ordem de Carregamento");                                                                                                                                                                                                  
                opdfViewer.open();                                                                                                                                                                                                                             
                // oBusyDialog.close();                                                                                                                                                                                                                        
            };                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        getAMSTData: function () {                                                                                                                                                                                                                             
            let oFilter = this.getView().byId("listReportFilter").getFilters();                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                        
            for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                                  
                var v_ordemFrete = oCtx.getObject().OrdemFrete                                                                                                                                                                                                 
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            // get the Model reference                                                                                                                                                                                                                         
            var oModel = this.getView().getModel();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                     
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                // Perform Read operation and pass billingdoc as parameter to URL                                                                                                                                                                              
                oModel.read("/AMST(p_ordemFrete='" + v_ordemFrete + "')/Set", {                                                                                                                                                                                
                    //filters: oFilter,                                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    success: function (oData, oResponse) {                                                                                                                                                                                                     
                        resolve(oData);                                                                                                                                                                                                                        
                    },                                                                                                                                                                                                                                         
                    error: function (oError) {                                                                                                                                                                                                                 
                        MessageBox.error("Não há envelope de amostra na Ordem de Frete " + v_ordemFrete );                                                                                                                                                     
                        reject(oError);                                                                                                                                                                                                                        
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onPrintAMST: async function (oEvent) {                                                                                                                                                                                                                 
            let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                        
            for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                                  
                var v_ordemFrete = oCtx.getObject().OrdemFrete                                                                                                                                                                                                 
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            if (v_ordemFrete == '' || v_ordemFrete == null){&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                           
                MessageBox.error("Para extrair o formulário de Amostragem é obrigatório informar uma Ordem de Frete.\nInforme a Ordem de Frete e tente novamente.");                                                                                           
            }else{                                                                                                                                                                                                                                             
                var opdfViewer = new PDFViewer();                                                                                                                                                                                                              
                this.getView().addDependent(opdfViewer);                                                                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                // Get the PDF data&nbsp;                                                                                                                                                                                                                      
                var vPDF = await this.getAMSTData();                                                                                                                                                                                                           
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                if(vPDF.results[0].no_envelope === 'X'){                                                                                                                                                                                                       
                    MessageBox.error("Não há envelope de amostra na Ordem de Frete " + v_ordemFrete );                                                                                                                                                         
                    return;                                                                                                                                                                                                                                    
                }else if (vPDF === ''){                                                                                                                                                                                                                        
                    MessageBox.error("Erro ao gerar PDF")                                                                                                                                                                                                      
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                let base64EncodedPDF = vPDF.results[0].stream_data;                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                let decodedPdfContent = atob(base64EncodedPDF);                                                                                                                                                                                                
                let byteArray = new Uint8Array(decodedPdfContent.length);                                                                                                                                                                                      
                for (var i = 0; i < decodedPdfContent.length; i++) {                                                                                                                                                                                           
                    byteArray[i] = decodedPdfContent.charCodeAt(i);                                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
                var blob = new Blob([byteArray.buffer], {                                                                                                                                                                                                      
                    type: 'application/pdf'                                                                                                                                                                                                                    
                });                                                                                                                                                                                                                                            
                var pdfurl = URL.createObjectURL(blob);                                                                                                                                                                                                        
                jQuery.sap.addUrlWhitelist("blob"); // register blob url as whitelist                                                                                                                                                                          
                opdfViewer.setSource(pdfurl);                                                                                                                                                                                                                  
                opdfViewer.setVisible(true);                                                                                                                                                                                                                   
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                opdfViewer.setTitle("Formulário de Amostragem");                                                                                                                                                                                               
                opdfViewer.open();                                                                                                                                                                                                                             
            };                                                                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    };                                                                                                                                                                                                                                                         
});                                                                                                                                                                                                                                                            