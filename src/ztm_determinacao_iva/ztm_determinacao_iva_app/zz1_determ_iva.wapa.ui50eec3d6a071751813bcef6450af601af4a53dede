sap.ui.define([                                                                                                                                                                                                                                                
    // "sap/m/MessageToast",                                                                                                                                                                                                                                   
    "sap/ui/export/Spreadsheet",                                                                                                                                                                                                                               
    "sap/ui/export/library"                                                                                                                                                                                                                                    
], function (Spreadsheet, library, MessageToast) {                                                                                                                                                                                                             
    'use strict';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return sap.ui.controller("br.com.redesim.determinacaoiva.ext.controller.ListReportExt", {                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        onModelo: function (oEvent) {                                                                                                                                                                                                                          
            // MessageToast.show("Custom handler invoked.");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
                Configura colunas do excel                                                                                                                                                                                                                     
                =================================================================== */                                                                                                                                                                         
            var aCols = [];                                                                                                                                                                                                                                    
            var filename = 'Modelo.xlsx';                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            aCols.push({                                                                                                                                                                                                                                       
                label: 'Cen√°rio',                                                                                                                                                                                                                              
                property: 'Cenario',                                                                                                                                                                                                                           
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            // aCols.push({                                                                                                                                                                                                                                    
            //     label: 'Tomador',                                                                                                                                                                                                                           
            //     property: 'Tomador',                                                                                                                                                                                                                        
            //     type: library.EdmType.String                                                                                                                                                                                                                
            // });                                                                                                                                                                                                                                             
            aCols.push({                                                                                                                                                                                                                                       
                label: 'UF Origem',                                                                                                                                                                                                                            
                property: 'Uforigem',                                                                                                                                                                                                                          
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            aCols.push({                                                                                                                                                                                                                                       
                label: 'UF Destino',                                                                                                                                                                                                                           
                property: 'Ufdestino',                                                                                                                                                                                                                         
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            aCols.push({                                                                                                                                                                                                                                       
                label: 'UF Transportadora',                                                                                                                                                                                                                    
                property: 'Uftransportadora',                                                                                                                                                                                                                  
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            aCols.push({                                                                                                                                                                                                                                       
                label: 'Transportadora (BP)',                                                                                                                                                                                                                  
                property: 'Transportadora',                                                                                                                                                                                                                    
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            aCols.push({                                                                                                                                                                                                                                       
                label: 'Cliente/Fornecedor (BP)',                                                                                                                                                                                                              
                property: 'Clientefornec',                                                                                                                                                                                                                     
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            aCols.push({                                                                                                                                                                                                                                       
                label: 'IVA',                                                                                                                                                                                                                                  
                property: 'Iva',                                                                                                                                                                                                                               
                type: library.EdmType.String                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            var oSettings = {                                                                                                                                                                                                                                  
                workbook: { columns: aCols },                                                                                                                                                                                                                  
                dataSource: [''],                                                                                                                                                                                                                              
                count: 1,                                                                                                                                                                                                                                      
                fileName: filename,                                                                                                                                                                                                                            
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            var oSheet = new Spreadsheet(oSettings);                                                                                                                                                                                                           
            oSheet.build().finally(function () {                                                                                                                                                                                                               
                oSheet.destroy();                                                                                                                                                                                                                              
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onUpload: function (oEvent) {                                                                                                                                                                                                                          
            // MessageToast.show("Custom handler invoked.");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            var that = this;                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
             Cria Dialogo dinamico (pop-up)                                                                                                                                                                                                                    
            =================================================================== */                                                                                                                                                                             
            var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                             
                contentWidth: "300px",                                                                                                                                                                                                                         
                resizable: true,                                                                                                                                                                                                                               
                type: "Message"                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
            oUploadDialog.setTitle("Carregar arquivo Excel");                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Define o servico gateway que ser chamado                                                                                                                                                                                                           
            =================================================================== */                                                                                                                                                                             
            var sServiceUrl = "/sap/opu/odata/sap/ZTM_DETERMINACAO_IVA_SRV/";                                                                                                                                                                                  
            var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                                
            var sSource = sServiceUrl + "UploadFileSet";                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Chama Gateway para processar logs                                                                                                                                                                                                                  
            =================================================================== */                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Prepara o responsavel pela carga do arquivo                                                                                                                                                                                                        
            =================================================================== */                                                                                                                                                                             
            var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                              
                width: "100%",                                                                                                                                                                                                                                 
                fileType: ["xlsx", "xls", "csv"],                                                                                                                                                                                                              
                typeMissmatch: this.handleTypeMissmatch,                                                                                                                                                                                                       
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
           Define parametros                                                                                                                                                                                                                                   
           =================================================================== */                                                                                                                                                                              
            oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                          
            oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                               
            oFileUploader.setSendXHR(true);                                                                                                                                                                                                                    
            oFileUploader.setUseMultipart(false);                                                                                                                                                                                                              
            oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                            
                name: "x-csrf-token",                                                                                                                                                                                                                          
                value: oModel.getSecurityToken()                                                                                                                                                                                                               
            });                                                                                                                                                                                                                                                
            oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Cria botao para a carga do arquivo                                                                                                                                                                                                                 
            =================================================================== */                                                                                                                                                                             
            var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                            
                text: 'Upload',                                                                                                                                                                                                                                
                type: 'Accept',                                                                                                                                                                                                                                
                press: function () {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    // Verifica se arquivo foi informado                                                                                                                                                                                                       
                    var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                               
                    var file = domRef.files[0];                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    if (oFileUploader.getValue() === '') {                                                                                                                                                                                                     
                        sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                                
                        return;                                                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                              
                        name: "Content-Type",                                                                                                                                                                                                                  
                        value: file.type                                                                                                                                                                                                                       
                    });                                                                                                                                                                                                                                        
                    oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                             
                        name: "SLUG",                                                                                                                                                                                                                          
                        value: oFileUploader.getValue()                                                                                                                                                                                                        
                    }));                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    var fnFunctionTeste = function (oEvent) {                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        return new Promise(function (showSuccessMessage, showErrorMessage) {                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            oFileUploader.attachUploadComplete(                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                function (oEvent) {                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                    // Atualiza tabela do relatorio apos carga                                                                                                                                                                                 
                                    //var sId = that.oView.sId + '--responsiveTable';                                                                                                                                                                          
                                    //var oTable = that.byId(sId);                                                                                                                                                                                             
                                    //oTable.getModel().refresh(true);                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                    oUploadDialog.close();                                                                                                                                                                                                     
                                    oUploadDialog.destroy();                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                    // Verifica o retorno da mensagem                                                                                                                                                                                          
                                    if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                  
                                        oEvent.mParameters.status == '201' ||                                                                                                                                                                                  
                                        oEvent.mParameters.status == '204') {                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                        that.showLog(oEvent.mParameters.responseRaw);                                                                                                                                                                          
                                        // sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                            
                                        showSuccessMessage();                                                                                                                                                                                                  
                                        //alert("Carga realizada com sucesso.");                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                    }                                                                                                                                                                                                                          
                                    else {                                                                                                                                                                                                                     
                                        that.showLogException(oEvent.mParameters.responseRaw);                                                                                                                                                                 
                                        showErrorMessage();                                                                                                                                                                                                    
                                        // sap.m.MessageToast.show("Erro na carga.");                                                                                                                                                                          
                                    }                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                    that.templateBaseExtension.getExtensionAPI().refreshTable();                                                                                                                                                               
                                    //debugger;                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                }.bind(this)                                                                                                                                                                                                                   
                            );                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            oFileUploader.upload();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        }.bind(this))                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                    var mParameters = {                                                                                                                                                                                                                        
                        sActionLabel: 'Upload de Arquivo',                                                                                                                                                                                                     
                        dataloss: false                                                                                                                                                                                                                        
                    };                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    this.extensionAPI.securedExecution(fnFunctionTeste, mParameters);                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Cria bot o de cancelar                                                                                                                                                                                                                             
            =================================================================== */                                                                                                                                                                             
            var oCancelButton = new sap.m.Button({                                                                                                                                                                                                             
                text: 'Cancelar',                                                                                                                                                                                                                              
                type: 'Reject',                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                press: function () {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    oUploadDialog.close();                                                                                                                                                                                                                     
                    oUploadDialog.destroy();                                                                                                                                                                                                                   
                    this.getView().removeAllDependents();                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Chama dialogo com a logica de carga&nbsp;                                                                                                                                                                                                          
            =================================================================== */                                                                                                                                                                             
            oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                           
            oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                       
            oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                        
            oUploadDialog.open();                                                                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        handleTypeMissmatch: function (oEvent) {                                                                                                                                                                                                               
            var aFileTypes = oEvent.getSource().getFileType();                                                                                                                                                                                                 
            jQuery.each(aFileTypes, function (key, value) { aFileTypes[key] = "*." + value; });                                                                                                                                                                
            var sSupportedFileTypes = aFileTypes.join(", ");                                                                                                                                                                                                   
            sap.m.MessageToast.show("Tipo de arquivo *." + oEvent.getParameter("fileType") +                                                                                                                                                                   
                " nao ? suportado. Escolha um dos tipos a seguir: " +                                                                                                                                                                                          
                sSupportedFileTypes);                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        showLog: function (sMessage) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            // Recupera texto da mensagem                                                                                                                                                                                                                      
            let aMessage = [];                                                                                                                                                                                                                                 
            for (const res of sMessage.matchAll(/(?:<d:MESSAGE>(.*?)<[/]d:MESSAGE>)/gm)) {                                                                                                                                                                     
                aMessage.push(res[1]);                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Recupera o tipo da mensagem                                                                                                                                                                                                                     
            let aSeverity = [];                                                                                                                                                                                                                                
            for (const res of sMessage.matchAll(/(?:<d:SEVERITY>(.*?)<[/]d:SEVERITY>)/gm)) {                                                                                                                                                                   
                switch (res[1]) {                                                                                                                                                                                                                              
                    case "E":                                                                                                                                                                                                                                  
                        aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                                         
                        break;                                                                                                                                                                                                                                 
                    case "I":                                                                                                                                                                                                                                  
                        aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                    case "S":                                                                                                                                                                                                                                  
                        aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                                       
                        break;                                                                                                                                                                                                                                 
                    case "W":                                                                                                                                                                                                                                  
                        aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                                       
                        break;                                                                                                                                                                                                                                 
                    default:                                                                                                                                                                                                                                   
                        aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                                          
                        break;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Exibe mensagem                                                                                                                                                                                                                                  
            for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                if (aMessage[i] == "Ocorreu uma exce√ß√£o") {                                                                                                                                                                                                    
                    continue;                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //alert(aMessage[i]);                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                //MessageManager.addMessages(new sap.ui.core.message.Message({                                                                                                                                                                                 
                sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                                             
                    message: aMessage[i],                                                                                                                                                                                                                      
                    persistent: true, // create message as transition message                                                                                                                                                                                  
                    type: aSeverity[i]                                                                                                                                                                                                                         
                }));                                                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        showLogException: function (sMessage) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            // Recupera texto da mensagem                                                                                                                                                                                                                      
            let aMessage = [];                                                                                                                                                                                                                                 
            for (const res of sMessage.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                                                         
                aMessage.push(res[1]);                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Recupera o tipo da mensagem                                                                                                                                                                                                                     
            let aSeverity = [];                                                                                                                                                                                                                                
            for (const res of sMessage.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)) {                                                                                                                                                                       
                switch (res[1]) {                                                                                                                                                                                                                              
                    case "error":                                                                                                                                                                                                                              
                        aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                                         
                        break;                                                                                                                                                                                                                                 
                    case "info":                                                                                                                                                                                                                               
                        aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                    case "success":                                                                                                                                                                                                                            
                        aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                                       
                        break;                                                                                                                                                                                                                                 
                    case "warning":                                                                                                                                                                                                                            
                        aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                                       
                        break;                                                                                                                                                                                                                                 
                    default:                                                                                                                                                                                                                                   
                        aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                                          
                        break;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Exibe mensagem                                                                                                                                                                                                                                  
            for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                if (aMessage[i] == "Ocorreu uma exce√ß√£o") {                                                                                                                                                                                                    
                    continue;                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //alert(aMessage[i]);                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                //MessageManager.addMessages(new sap.ui.core.message.Message({                                                                                                                                                                                 
                sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                                             
                    message: aMessage[i],                                                                                                                                                                                                                      
                    persistent: true, // create message as transition message                                                                                                                                                                                  
                    type: aSeverity[i]                                                                                                                                                                                                                         
                }));                                                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    });                                                                                                                                                                                                                                                        
},                                                                                                                                                                                                                                                             
);                                                                                                                                                                                                                                                             